#!/usr/bin/env bash

__dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source $__dir/config.sh

get_help() {
    echo "A tool to help schedule studies
    It considers a study period one hour and you cannot study in a row.

    Usage:

    $0 (edit-subjects|-es|-e)                                         opens the subjects on your editor
    $0 (edit-history|-eh)                                                   opens the history on your editor
    $0 (done | -d ) <subject> <what was done> [what to do next]       opens the history on your editor
    $0 total                                                          show how much did you spent in any activity
    $0 log                                                            shows the log
    $0 goal             show your goals status
    $0 (edit-goals|-eg)                                                edit your goals
    "
}

[[ "$@" =~ "--help" ]] || [[ "$*" =~ "-h" ]]&& {
    get_help
    exit
}

[[ "$1"  == "-d" ]] || [[ "$1"  == "done" ]]  && {
    $__dir/done.sh "$@"
    exit
}

[[ "$1"  == "level" ]]  && {
    $__dir/level.sh "${@:2}"
    exit
}

[[ "$@"  =~ "total" ]] && {
    $__dir/timePerSubject.py "${@:2}" | less
    exit
}
[[ "$@"  =~ goal$ ]] && {
    $__dir/goals.sh "${@:2}" | less
    exit
}

[[ "$@"  == "summary" ]] && {
    echo "Done Today: "$($__dir/gateway.sh done_today | wc -l)
    echo "Done Week: "$($__dir/gateway.sh done_week | wc -l)
    exit
}

[[ "$@"  == "init" ]] && {
    [ ! -f "$WHATNEXT_CONF" ] && {
       echo "myFirstSubject|50|50|do something" > "$WHATNEXT_CONF"
    }

    [ ! -f "$WHATNEXT_HISTORY" ] && {
       echo "myFirstSubject|50|50|do something" > "$WHATNEXT_HISTORY"
    }
    exit 0
}

[[ "$@"  == "log" ]] && {
    log_data() {
    log=$(tac "$WHATNEXT_HISTORY")
    current_entry=$(echo "$log" | wc -l )
IFS='
'
    for i in $log
    do
        date=$(echo $i | cut -d '|' -f1)
        subject=$(echo $i | cut -d '|' -f2)
        description=$(echo $i | cut -d '|' -f3)
        echo -e "$WN_COLOR_ORANGE $current_entry $WN_COLOR_TITLE $subject $WN_COLOR_RESET"
        echo "Date:     $date"
        echo "      $description"
        echo ""
        current_entry=$(( $current_entry - 1 ))

    done
}

    log_data | less
    exit
}

[[ "$@"  == "list-subjects" ]] && {
    $__dir/gateway.sh list_subjects_names
    exit
}

[[ "$@"  == "edit-goals" ]] || [[ "$@"  == "-eg" ]] && {
    [ ! -z ${EDITOR+x} ] && {
        $EDITOR "$WHATNEXT_GOALS"
    } || {
        vim "$WHATNEXT_GOALS"
    }
    exit
}

[[ "$@"  == "edit-subjects" ]] || [[ "$@"  == "-es" ]] || [[ "$@"  == "-e" ]] && {
    [ ! -z ${EDITOR+x} ] && {
        $EDITOR "$WHATNEXT_CONF"
    } || {
        vim "$WHATNEXT_CONF"
    }
    exit
}

[[ "$@"  == "-eh" ]] || [[ "$@"  == "edit-history" ]] && {
    [ ! -z ${EDITOR+x} ] && {
        $EDITOR "$WHATNEXT_HISTORY"
    } || {
        vim "$WHATNEXT_HISTORY"
    }
    exit
}

[[ ! -z "$@" ]]  && {
    echo "Option not found"
    exit 1
}

$__dir/scheduler.py | less
