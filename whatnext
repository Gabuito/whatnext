#!/usr/bin/env bash

__dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

get_help() {
    echo "A tool to help schedule studies
    It considers a study period one hour and you cannot study in a row.

    Usage:

    $0 (--edit-subjects|-es)                                            opens the subjects on your editor
    $0 --edit-history                                                   opens the history on your editor
    $0 (--done | -d ) <subject> <what was done> [what to do next]       opens the history on your editor 
    $0 --summary                                                        displays statistics about your usage
    $0 --log                                                            shows the log
    "
}

[[ "$@" =~ "--help" ]] || [[ "$@" =~ ^-h$ ]]&& {
    get_help
    exit
}

[[ "$1"  == "-d" ]] || [[ "$1"  == "--done" ]]  && {
    subject="$2"

    [[ ! $($__dir/gateway.sh list_subjects_names | grep "$subject") ]]  && {
        echo 'subject not found'
        exit 1
    }

    [[ ! -z ${4+x} ]] && {
        what_to_do_next="$4"
        subject_config=$(cat ~/.whatnext.conf | grep "$subject")
        subject_config_without_description=$(echo "$subject_config" | rev | cut -d '|' -f1 --complement | rev)
        new_subject_config_entry="$subject_config_without_description|$what_to_do_next"

        subject_config_line=$(cat ~/.whatnext.conf | grep "$subject" -n|cut -d ':' -f1)

        sed -i "$subject_config_line"'s/.*/'"$new_subject_config_entry"'/' ~/.whatnext.conf
    }
    echo "$( date "+%Y-%m-%d %H:%M:%S")|$subject|$3" >> ~/.whatnext_history

    exit
}

[[ "$@"  == "--summary" ]] && {
    echo "Done Today: "$($__dir/gateway.sh done_today | wc -l)
    echo "Done Week: "$($__dir/gateway.sh done_week | wc -l)
    exit
}


[[ "$@"  == "--log" ]] && {
    log_data() {
    log=$(tac ~/.whatnext_history)
    current_entry=$(echo "$log" | wc -l )
IFS='
'
    for i in $log
    do
        date=$(echo $i | cut -d '|' -f1)
        subject=$(echo $i | cut -d '|' -f2)
        description=$(echo $i | cut -d '|' -f3)
        echo -e "\e[5;33;40m $current_entry $subject \e[0m"
        echo "Date:     $date"
        echo "      $description"

        echo ""
        current_entry=$(( $current_entry - 1 ))

    done
}

    log_data | less
    exit
}



[[ "$@"  == "--list-subjects" ]] && {
    $__dir/gateway.sh list_subjects_names
    exit
}

[[ "$@"  == "--edit-subjects" ]] || [[ "$@"  == "-es" ]] && {
    [ ! -z ${EDITOR+x} ] && {
        $EDITOR ~/.whatnext.conf
    } || {
        vim ~/.whatnext.conf
    }
    exit
}

[[ "$@"  == "--edit-history" ]] && {
    [ ! -z ${EDITOR+x} ] && {
        $EDITOR ~/.whatnext_history
    } || {
        vim ~/.whatnext_history
    }
    exit
}

$__dir/scheduler.py | less
